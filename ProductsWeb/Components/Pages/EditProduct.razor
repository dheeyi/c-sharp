@page "/products/edit/{Id:int}"
@rendermode InteractiveServer
@inject ProductService ProductService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Editar Producto</PageTitle>

<MudText Typo="Typo.h3" Class="mb-4">Editar Producto</MudText>

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}
else if (_notFound)
{
    <MudAlert Severity="Severity.Error">Producto no encontrado</MudAlert>
}
else
{
    <MudCard Elevation="3" Class="pa-4" Style="max-width: 600px;">
        <MudForm @ref="_form" @bind-IsValid="_isValid">
            <MudCardContent>
                <MudTextField @bind-Value="dto.Name"
                              Label="Nombre del Producto"
                              Variant="Variant.Outlined"
                              Required="true"
                              Placeholder="Ej: Laptop Dell XPS 13"
                              Class="mb-4" />

                <MudNumericField @bind-Value="dto.Price"
                                 Label="Precio"
                                 Variant="Variant.Outlined"
                                 Required="true"
                                 Min="0.01m"
                                 Step="0.01m"
                                 Format="N2"
                                 Adornment="Adornment.Start"
                                 AdornmentText="$" />
            </MudCardContent>

            <MudCardActions Class="d-flex justify-end gap-2">
                <MudButton Variant="Variant.Text" OnClick="Cancel">
                    Cancelar
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="Save"
                           Disabled="@(!_isValid || _saving)">
                    @if (_saving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Guardar
                </MudButton>
            </MudCardActions>
        </MudForm>
    </MudCard>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private MudForm _form = null!;
    private bool _isValid;
    private bool _saving;
    private bool _loading = true;
    private bool _notFound;
    private UpdateProductDto dto = new();

    protected override async Task OnInitializedAsync()
    {
        var product = await ProductService.GetByIdAsync(Id);

        if (product is null)
        {
            _notFound = true;
        }
        else
        {
            dto.Name = product.Name;
            dto.Price = product.Price;
        }

        _loading = false;
    }

    private async Task Save()
    {
        _saving = true;

        var success = await ProductService.UpdateAsync(Id, dto);

        if (success)
        {
            Snackbar.Add("Producto actualizado", Severity.Success);
            NavigationManager.NavigateTo("/products");
        }
        else
        {
            Snackbar.Add("Error al actualizar", Severity.Error);
        }

        _saving = false;
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/products");
    }
}
